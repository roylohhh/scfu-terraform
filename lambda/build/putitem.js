var d=(e,a)=>()=>(a||e((a={exports:{}}).exports,a),a.exports);var A=d(k=>{"use strict";Object.defineProperty(k,"__esModule",{value:!0});k.default=b;var Y=Z(require("crypto"));function Z(e){return e&&e.__esModule?e:{default:e}}function b(){return Y.default.randomBytes(16)}});var q=d(g=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0});g.default=void 0;var T=[];for(m=0;m<256;++m)T[m]=(m+256).toString(16).substr(1);var m;function j(e,a){var r=a||0,t=T;return[t[e[r++]],t[e[r++]],t[e[r++]],t[e[r++]],"-",t[e[r++]],t[e[r++]],"-",t[e[r++]],t[e[r++]],"-",t[e[r++]],t[e[r++]],"-",t[e[r++]],t[e[r++]],t[e[r++]],t[e[r++]],t[e[r++]],t[e[r++]]].join("")}var ee=j;g.default=ee});var N=d(p=>{"use strict";Object.defineProperty(p,"__esModule",{value:!0});p.default=void 0;var re=C(A()),te=C(q());function C(e){return e&&e.__esModule?e:{default:e}}var K,P,E=0,H=0;function ae(e,a,r){var t=a&&r||0,n=a||[];e=e||{};var u=e.node||K,f=e.clockseq!==void 0?e.clockseq:P;if(u==null||f==null){var s=e.random||(e.rng||re.default)();u==null&&(u=K=[s[0]|1,s[1],s[2],s[3],s[4],s[5]]),f==null&&(f=P=(s[6]<<8|s[7])&16383)}var o=e.msecs!==void 0?e.msecs:new Date().getTime(),i=e.nsecs!==void 0?e.nsecs:H+1,c=o-E+(i-H)/1e4;if(c<0&&e.clockseq===void 0&&(f=f+1&16383),(c<0||o>E)&&e.nsecs===void 0&&(i=0),i>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");E=o,H=i,P=f,o+=122192928e5;var l=((o&268435455)*1e4+i)%4294967296;n[t++]=l>>>24&255,n[t++]=l>>>16&255,n[t++]=l>>>8&255,n[t++]=l&255;var h=o/4294967296*1e4&268435455;n[t++]=h>>>8&255,n[t++]=h&255,n[t++]=h>>>24&15|16,n[t++]=h>>>16&255,n[t++]=f>>>8|128,n[t++]=f&255;for(var y=0;y<6;++y)n[t+y]=u[y];return a||(0,te.default)(n)}var ne=ae;p.default=ne});var R=d(v=>{"use strict";Object.defineProperty(v,"__esModule",{value:!0});v.default=oe;v.URL=v.DNS=void 0;var ue=fe(q());function fe(e){return e&&e.__esModule?e:{default:e}}function se(e){var a=[];return e.replace(/[a-fA-F0-9]{2}/g,function(r){a.push(parseInt(r,16))}),a}function ie(e){e=unescape(encodeURIComponent(e));for(var a=new Array(e.length),r=0;r<e.length;r++)a[r]=e.charCodeAt(r);return a}var U="6ba7b810-9dad-11d1-80b4-00c04fd430c8";v.DNS=U;var F="6ba7b811-9dad-11d1-80b4-00c04fd430c8";v.URL=F;function oe(e,a,r){var t=function(n,u,f,s){var o=f&&s||0;if(typeof n=="string"&&(n=ie(n)),typeof u=="string"&&(u=se(u)),!Array.isArray(n))throw TypeError("value must be an array of bytes");if(!Array.isArray(u)||u.length!==16)throw TypeError("namespace must be uuid string or an Array of 16 byte values");var i=r(u.concat(n));if(i[6]=i[6]&15|a,i[8]=i[8]&63|128,f)for(var c=0;c<16;++c)f[o+c]=i[c];return f||(0,ue.default)(i)};try{t.name=e}catch{}return t.DNS=U,t.URL=F,t}});var I=d(M=>{"use strict";Object.defineProperty(M,"__esModule",{value:!0});M.default=void 0;var le=de(require("crypto"));function de(e){return e&&e.__esModule?e:{default:e}}function ce(e){return Array.isArray(e)?e=Buffer.from(e):typeof e=="string"&&(e=Buffer.from(e,"utf8")),le.default.createHash("md5").update(e).digest()}var ve=ce;M.default=ve});var L=d(w=>{"use strict";Object.defineProperty(w,"__esModule",{value:!0});w.default=void 0;var _e=B(R()),me=B(I());function B(e){return e&&e.__esModule?e:{default:e}}var he=(0,_e.default)("v3",48,me.default),ye=he;w.default=ye});var J=d(x=>{"use strict";Object.defineProperty(x,"__esModule",{value:!0});x.default=void 0;var ge=$(A()),qe=$(q());function $(e){return e&&e.__esModule?e:{default:e}}function pe(e,a,r){var t=a&&r||0;typeof e=="string"&&(a=e==="binary"?new Array(16):null,e=null),e=e||{};var n=e.random||(e.rng||ge.default)();if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,a)for(var u=0;u<16;++u)a[t+u]=n[u];return a||(0,qe.default)(n)}var Me=pe;x.default=Me});var V=d(D=>{"use strict";Object.defineProperty(D,"__esModule",{value:!0});D.default=void 0;var we=xe(require("crypto"));function xe(e){return e&&e.__esModule?e:{default:e}}function De(e){return Array.isArray(e)?e=Buffer.from(e):typeof e=="string"&&(e=Buffer.from(e,"utf8")),we.default.createHash("sha1").update(e).digest()}var Oe=De;D.default=Oe});var z=d(O=>{"use strict";Object.defineProperty(O,"__esModule",{value:!0});O.default=void 0;var Se=W(R()),ke=W(V());function W(e){return e&&e.__esModule?e:{default:e}}var Ae=(0,Se.default)("v5",80,ke.default),Pe=Ae;O.default=Pe});var G=d(_=>{"use strict";Object.defineProperty(_,"__esModule",{value:!0});Object.defineProperty(_,"v1",{enumerable:!0,get:function(){return Ee.default}});Object.defineProperty(_,"v3",{enumerable:!0,get:function(){return He.default}});Object.defineProperty(_,"v4",{enumerable:!0,get:function(){return Re.default}});Object.defineProperty(_,"v5",{enumerable:!0,get:function(){return Te.default}});var Ee=S(N()),He=S(L()),Re=S(J()),Te=S(z());function S(e){return e&&e.__esModule?e:{default:e}}});var{DynamoDBClient:Ke}=require("@aws-sdk/client-dynamodb"),{S3Client:Ce,DeleteObjectCommand:Ne}=require("@aws-sdk/client-s3"),{DynamoDBDocumentClient:Ue,BatchWriteCommand:Fe}=require("@aws-sdk/lib-dynamodb"),{v4:Ie}=G(),Q=require("crypto");var Be=new Ce({region:"ap-southeast-2"}),Le=e=>{let a=Q.randomBytes(16).toString("hex"),r=Q.createHash("sha256");return r.update(JSON.stringify(e)+a),{formHash:r.digest("hex"),saltKey:a}},$e=async e=>{let a=process.env.S3_BUCKET_NAME;if(!a)throw new Error("S3 bucket name is not defined in environment variables");if(!e||e.length===0){console.log("No files to roll back.");return}try{for(let r of e)if(r){let t={Bucket:a,Key:r};await Be.send(new Ne(t)),console.log(`Successfully rolled back (deleted) file with key: ${r}`)}}catch(r){throw console.error("Error rolling back files from S3:",r.message),new Error(`Failed to roll back files from S3: ${r.message}`)}},Je=new Ke({region:"ap-southeast-2"}),Ve=Ue.from(Je),X=process.env.PARTICIPANT_CONSENT_TABLE,We=async e=>{try{if(!X)throw new Error("Table name is not defined in environment variables");let r=["formData","admin","timeStamp","originalS3ObjectKey","originalS3Hash","watermarkedS3ObjectKey","watermarkedS3Hash"].filter(l=>!e[l]);if(r.length>0)throw new Error(`Missing required fields: ${r.join(", ")}.`);let{formData:t,admin:n,timeStamp:u,s3Map:f}=e,s=Le(t);if(!s||!s.formHash||!s.saltKey)throw new Error("hashMap with formHash and saltKey is required.");let o=Ie(),i=[{id:o,version:0,hashMap:{formHash:s.formHash,saltKey:s.saltKey},consentForm:t,admin:n,timeStamp:u,latestVersion:1},{id:o,version:1,hashMap:{formHash:s.formHash,saltKey:s.saltKey},consentForm:t,admin:n,timeStamp:u}];f&&f.s3Hash&&f.s3ObjectKey&&i.forEach(l=>{l.s3Map={s3Hash:f.s3Hash,s3ObjectKey:f.s3ObjectKey}});let c={RequestItems:{[X]:i.map(l=>({PutRequest:{Item:l}}))}};return await Ve.send(new Fe(c)),{status:"success",message:"Form submitted successfully"}}catch(a){console.error("Error occurred:",a.message);let r=[e.originalS3ObjectKey,e.watermarkedS3ObjectKey];return await $e(r),{status:"failure",message:a.message}}};module.exports={putFormItemHandler:We};
