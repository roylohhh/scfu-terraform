var ne=Object.create;var g=Object.defineProperty;var ue=Object.getOwnPropertyDescriptor;var fe=Object.getOwnPropertyNames;var se=Object.getPrototypeOf,oe=Object.prototype.hasOwnProperty;var d=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),ie=(e,t)=>{for(var r in t)g(e,r,{get:t[r],enumerable:!0})},F=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of fe(t))!oe.call(e,n)&&n!==r&&g(e,n,{get:()=>t[n],enumerable:!(a=ue(t,n))||a.enumerable});return e};var I=(e,t,r)=>(r=e!=null?ne(se(e)):{},F(t||!e||!e.__esModule?g(r,"default",{value:e,enumerable:!0}):r,e)),le=e=>F(g({},"__esModule",{value:!0}),e);var R=d(H=>{"use strict";Object.defineProperty(H,"__esModule",{value:!0});H.default=ve;var de=ce(require("crypto"));function ce(e){return e&&e.__esModule?e:{default:e}}function ve(){return de.default.randomBytes(16)}});var x=d(q=>{"use strict";Object.defineProperty(q,"__esModule",{value:!0});q.default=void 0;var B=[];for(_=0;_<256;++_)B[_]=(_+256).toString(16).substr(1);var _;function me(e,t){var r=t||0,a=B;return[a[e[r++]],a[e[r++]],a[e[r++]],a[e[r++]],"-",a[e[r++]],a[e[r++]],"-",a[e[r++]],a[e[r++]],"-",a[e[r++]],a[e[r++]],"-",a[e[r++]],a[e[r++]],a[e[r++]],a[e[r++]],a[e[r++]],a[e[r++]]].join("")}var _e=me;q.default=_e});var J=d(M=>{"use strict";Object.defineProperty(M,"__esModule",{value:!0});M.default=void 0;var he=$(R()),ye=$(x());function $(e){return e&&e.__esModule?e:{default:e}}var L,T,K=0,C=0;function pe(e,t,r){var a=t&&r||0,n=t||[];e=e||{};var u=e.node||L,f=e.clockseq!==void 0?e.clockseq:T;if(u==null||f==null){var s=e.random||(e.rng||he.default)();u==null&&(u=L=[s[0]|1,s[1],s[2],s[3],s[4],s[5]]),f==null&&(f=T=(s[6]<<8|s[7])&16383)}var i=e.msecs!==void 0?e.msecs:new Date().getTime(),o=e.nsecs!==void 0?e.nsecs:C+1,c=i-K+(o-C)/1e4;if(c<0&&e.clockseq===void 0&&(f=f+1&16383),(c<0||i>K)&&e.nsecs===void 0&&(o=0),o>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");K=i,C=o,T=f,i+=122192928e5;var l=((i&268435455)*1e4+o)%4294967296;n[a++]=l>>>24&255,n[a++]=l>>>16&255,n[a++]=l>>>8&255,n[a++]=l&255;var y=i/4294967296*1e4&268435455;n[a++]=y>>>8&255,n[a++]=y&255,n[a++]=y>>>24&15|16,n[a++]=y>>>16&255,n[a++]=f>>>8|128,n[a++]=f&255;for(var p=0;p<6;++p)n[a+p]=u[p];return t||(0,ye.default)(n)}var ge=pe;M.default=ge});var N=d(v=>{"use strict";Object.defineProperty(v,"__esModule",{value:!0});v.default=De;v.URL=v.DNS=void 0;var qe=xe(x());function xe(e){return e&&e.__esModule?e:{default:e}}function Me(e){var t=[];return e.replace(/[a-fA-F0-9]{2}/g,function(r){t.push(parseInt(r,16))}),t}function we(e){e=unescape(encodeURIComponent(e));for(var t=new Array(e.length),r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}var V="6ba7b810-9dad-11d1-80b4-00c04fd430c8";v.DNS=V;var W="6ba7b811-9dad-11d1-80b4-00c04fd430c8";v.URL=W;function De(e,t,r){var a=function(n,u,f,s){var i=f&&s||0;if(typeof n=="string"&&(n=we(n)),typeof u=="string"&&(u=Me(u)),!Array.isArray(n))throw TypeError("value must be an array of bytes");if(!Array.isArray(u)||u.length!==16)throw TypeError("namespace must be uuid string or an Array of 16 byte values");var o=r(u.concat(n));if(o[6]=o[6]&15|t,o[8]=o[8]&63|128,f)for(var c=0;c<16;++c)f[i+c]=o[c];return f||(0,qe.default)(o)};try{a.name=e}catch{}return a.DNS=V,a.URL=W,a}});var z=d(w=>{"use strict";Object.defineProperty(w,"__esModule",{value:!0});w.default=void 0;var Se=Oe(require("crypto"));function Oe(e){return e&&e.__esModule?e:{default:e}}function ke(e){return Array.isArray(e)?e=Buffer.from(e):typeof e=="string"&&(e=Buffer.from(e,"utf8")),Se.default.createHash("md5").update(e).digest()}var Ae=ke;w.default=Ae});var Q=d(D=>{"use strict";Object.defineProperty(D,"__esModule",{value:!0});D.default=void 0;var Pe=G(N()),Ee=G(z());function G(e){return e&&e.__esModule?e:{default:e}}var He=(0,Pe.default)("v3",48,Ee.default),Re=He;D.default=Re});var Y=d(S=>{"use strict";Object.defineProperty(S,"__esModule",{value:!0});S.default=void 0;var Te=X(R()),Ke=X(x());function X(e){return e&&e.__esModule?e:{default:e}}function Ce(e,t,r){var a=t&&r||0;typeof e=="string"&&(t=e==="binary"?new Array(16):null,e=null),e=e||{};var n=e.random||(e.rng||Te.default)();if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,t)for(var u=0;u<16;++u)t[a+u]=n[u];return t||(0,Ke.default)(n)}var Ne=Ce;S.default=Ne});var Z=d(O=>{"use strict";Object.defineProperty(O,"__esModule",{value:!0});O.default=void 0;var Ue=Fe(require("crypto"));function Fe(e){return e&&e.__esModule?e:{default:e}}function Ie(e){return Array.isArray(e)?e=Buffer.from(e):typeof e=="string"&&(e=Buffer.from(e,"utf8")),Ue.default.createHash("sha1").update(e).digest()}var Be=Ie;O.default=Be});var j=d(k=>{"use strict";Object.defineProperty(k,"__esModule",{value:!0});k.default=void 0;var Le=b(N()),$e=b(Z());function b(e){return e&&e.__esModule?e:{default:e}}var Je=(0,Le.default)("v5",80,$e.default),Ve=Je;k.default=Ve});var ee=d(m=>{"use strict";Object.defineProperty(m,"__esModule",{value:!0});Object.defineProperty(m,"v1",{enumerable:!0,get:function(){return We.default}});Object.defineProperty(m,"v3",{enumerable:!0,get:function(){return ze.default}});Object.defineProperty(m,"v4",{enumerable:!0,get:function(){return Ge.default}});Object.defineProperty(m,"v5",{enumerable:!0,get:function(){return Qe.default}});var We=A(J()),ze=A(Q()),Ge=A(Y()),Qe=A(j());function A(e){return e&&e.__esModule?e:{default:e}}});var rr={};ie(rr,{putFormItemHandler:()=>er});module.exports=le(rr);var ae=require("@aws-sdk/client-dynamodb"),P=require("@aws-sdk/client-s3"),E=require("@aws-sdk/lib-dynamodb");var h=I(ee(),1),vr=h.default.v1,mr=h.default.v3,re=h.default.v4,_r=h.default.v5;var U=I(require("crypto"));var Xe=new P.S3Client({region:"ap-southeast-2"}),Ye=e=>{let t=U.default.randomBytes(16).toString("hex"),r=U.default.createHash("sha256");return r.update(JSON.stringify(e)+t),{formHash:r.digest("hex"),saltKey:t}},Ze=async e=>{let t=process.env.S3_BUCKET_NAME;if(!t)throw new Error("S3 bucket name is not defined in environment variables");if(!e||e.length===0){console.log("No files to roll back.");return}try{for(let r of e)if(r){let a={Bucket:t,Key:r};await Xe.send(new P.DeleteObjectCommand(a)),console.log(`Successfully rolled back (deleted) file with key: ${r}`)}}catch(r){throw console.error("Error rolling back files from S3:",r.message),new Error(`Failed to roll back files from S3: ${r.message}`)}},be=new ae.DynamoDBClient({region:"ap-southeast-2"}),je=E.DynamoDBDocumentClient.from(be),te=process.env.PARTICIPANT_CONSENT_TABLE,er=async e=>{try{if(!te)throw new Error("Table name is not defined in environment variables");let r=["formData","admin","timeStamp","originalS3ObjectKey","originalS3Hash","watermarkedS3ObjectKey","watermarkedS3Hash"].filter(l=>!e[l]);if(r.length>0)throw new Error(`Missing required fields: ${r.join(", ")}.`);let{formData:a,admin:n,timeStamp:u,s3Map:f}=e,s=Ye(a);if(!s||!s.formHash||!s.saltKey)throw new Error("hashMap with formHash and saltKey is required.");let i=re(),o=[{id:i,version:0,hashMap:{formHash:s.formHash,saltKey:s.saltKey},consentForm:a,admin:n,timeStamp:u,latestVersion:1},{id:i,version:1,hashMap:{formHash:s.formHash,saltKey:s.saltKey},consentForm:a,admin:n,timeStamp:u}];f&&f.s3Hash&&f.s3ObjectKey&&o.forEach(l=>{l.s3Map={s3Hash:f.s3Hash,s3ObjectKey:f.s3ObjectKey}});let c={RequestItems:{[te]:o.map(l=>({PutRequest:{Item:l}}))}};return await je.send(new E.BatchWriteCommand(c)),{status:"success",message:"Form submitted successfully"}}catch(t){console.error("Error occurred:",t.message);let r=[e.originalS3ObjectKey,e.watermarkedS3ObjectKey];return await Ze(r),{status:"failure",message:t.message}}};0&&(module.exports={putFormItemHandler});
